{% extends "base.html" %} 
{% block title %}Calendar{% endblock %} {% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Booking Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    
    .calendar-day {
    height: 120px;
    position: relative;
    padding: 0;
    overflow: hidden;
    }

    .calendar-day-inner {
    height: 100%;
    position: relative;
    width: 100%;
    }
    .calendar-day:hover {
      background-color: #f8f9fa;
    }
    .calendar-header {
      background-color: #f1f1f1;
      text-align: center;
      font-weight: bold;
    }
    .calendar-day-inner {
    position: relative;
    height: 100%;
    width: 100%;
    }

    .calendar-slot {
    height: 50%;
    width: 100%;
    position: absolute;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 500;
    color: #000;
    padding: 2px;
    text-align: center;
    }

    .slot-morning {
    bottom: 0;
    background-color: #c8e6c9; /* light green */
    }

    .slot-afternoon {
    top: 0;
    background-color: #bbdefb; /* light blue */
    }

    .slot-full {
    top: 0;
    height: 100%;
    background-color: #90caf9; /* full blue */
    }

        .slot-unavailable {
    background-color: #f8d7da;
    color: #721c24;
    height: 50%;
    width: 100%;
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 500;
    text-align: center;
    padding: 2px;
    }

  </style>
</head>
<body>
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('views.calendar_view', year=prev_year, month=prev_month) }}"
        class="btn btn-outline-primary">
        &larr; {{ prev_month }}/{{ prev_year }}
        </a>

        <h2 class="mb-0">Booking Calendar &ndash; {{ month }}/{{ year }}</h2>

        <a href="{{ url_for('views.calendar_view', year=next_year, month=next_month) }}"
        class="btn btn-outline-primary">
        {{ next_month }}/{{ next_year }} &rarr;
        </a>
    </div>

    <!-- Calendar Header -->
    <div class="row text-center mb-2">
      <div class="col calendar-header">Sun</div>
      <div class="col calendar-header">Mon</div>
      <div class="col calendar-header">Tue</div>
      <div class="col calendar-header">Wed</div>
      <div class="col calendar-header">Thu</div>
      <div class="col calendar-header">Fri</div>
      <div class="col calendar-header">Sat</div>
    </div>

  <!-- Dynamic Day Grid -->
    {% for week in range(0, calendar_days|length, 7) %}
    <div class="row text-center">
        {% for day in calendar_days[week:week+7] %}
        {% if day %}
            <div class="col calendar-day p-0" onclick="openTrainingBookingModal('{{ day.isoformat() }}')">
            <div class="calendar-day-inner border">
                <div class="position-absolute top-0 start-0 w-100 text-start ps-1 small">{{ day.day }}</div>

                {% set bookings = booked_by_day.get(day.day) %}
                {% if bookings %}
                {% for b in bookings %}
                    {% if b.user_id == user.id %}
                        <!-- Show your own bookings normally -->
                        <div class="calendar-slot slot-{{ b.training_type }}">{{ b.time_slot }}</div>
                        {% if b.training_type == 'full_day' %}
                            <div class="calendar-slot slot-full">{{ b.time_slot }}</div>
                        {% elif b.training_type == 'morning_half' %}
                            <div class="calendar-slot slot-morning">{{ b.time_slot }}</div>
                        {% elif b.training_type == 'afternoon_half' %}
                            <div class="calendar-slot slot-afternoon">{{ b.time_slot }}</div>
                        {% endif %}
                    {% else %}
                        <!-- Show red block for other users' bookings -->
                        <div class="calendar-slot slot-unavailable"
                            style="
                            {{ 'top: 0;' if b.training_type == 'afternoon_half' else '' }}
                            {{ 'bottom: 0;' if b.training_type == 'morning_half' else '' }}
                            {{ 'height: 100%;' if b.training_type == 'full_day' else '' }}">
                        {{ b.time_slot }} Unavailable
                        </div>
                    {% endif %}
                {% endfor %}
                {% else %}
                <!-- force layout structure even without content -->
                <div class="calendar-slot" style="height: 100%; visibility: hidden;"></div>
                {% endif %}
            </div>
            </div>
        {% else %}

            <div class="col calendar-day text-muted border" style="height: 100%; visibility: hidden;""></div>
        {% endif %}
        {% endfor %}
    </div>
    {% endfor %}

<!-- Training Booking Modal -->
<div class="modal fade" id="trainingBookingModal" tabindex="-1" aria-labelledby="trainingBookingLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="POST" action="{{ url_for('views.book_training') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="trainingBookingLabel">Book Training</h5>
        <a href="{{ url_for('views.calendar_view') }}" class="btn btn-group btn-secondary">Close</a>
      </div>

        <!-- Modal Body -->
      <div class="modal-body">
        <input type="hidden" id="booking-date" name="date">  <!-- Hidden date -->

        <div class="mb-3">
            <label for="training-name" class="form-label">Your Name</label>
            <input type="text" class="form-control" id="training-name" name="name" required>
        </div>

        <div class="mb-3">
            <label for="training-type" class="form-label">Training Session</label>
            <select class="form-select" id="training-type" name="training_type" required>
             <option selected disabled value="">Select training type</option>
             <option value="full_day">Full Day</option>
             <option value="morning_half">Morning Half Day (9am - 12 pm)</option>
             <option value="afternoon_half">Afternoon Half Day (1pm - 4 pm)</option>
            </select>
        </div>
      </div>

      <div class="modal-footer">
        <!-- Cancel -->
        <a href="{{ url_for('views.calendar_view') }}" class="btn btn-group btn-secondary">Cancel</a>
        <!-- Save -->
        <button type="submit" class="btn btn-primary">Save Booking</button>
      </div>
    </form>
  </div>
</div>

<!-- Trigger Script -->
<script>
    const bookingsData = {{ booked_by_day | tojson }};
      
    function openTrainingBookingModal(date) {
    document.getElementById("booking-date").value = date;

    const select = document.getElementById("training-type");

    // Reset all options
    for (const opt of select.options) {
        opt.disabled = false;
        opt.hidden = false;
        opt.textContent = opt.getAttribute("data-label") || opt.textContent;
        opt.classList.remove("text-danger");
    }

    const day = new Date(date).getDate().toString();
    const bookings = bookingsData[day] || [];

    const typesBooked = bookings.map(b => b.training_type);

    const disable = type => {
        const opt = [...select.options].find(o => o.value === type);
        if (opt) {
        opt.disabled = true;
        opt.classList.add("text-danger");
        opt.textContent = opt.textContent.replace(/(\(.*\))?/, "(Unavailable)");
        }
    };

    // If full day is booked, disable everything and add a disabled option
    if (typesBooked.includes("full_day")) {
        select.innerHTML = `
        <option disabled selected>No shifts available</option>
        `;
    } else {
        if (typesBooked.includes("morning_half")) {
        disable("morning_half");
        disable("full_day");
        }
        if (typesBooked.includes("afternoon_half")) {
        disable("afternoon_half");
        disable("full_day");
        }

        // If both halves are booked, hide the dropdown and show message
        if (typesBooked.includes("morning_half") && typesBooked.includes("afternoon_half")) {
        select.innerHTML = `
            <option disabled selected>No shifts available</option>
        `;
        }
    }

    const modal = new bootstrap.Modal(document.getElementById("trainingBookingModal"));
    modal.show();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

{% endblock %}


